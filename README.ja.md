# Kotlin + Dagger2 + DataBinding + Orma

OrmaDatabaseの依存性をDagger2を使って注入しようというサンプル。

これをすべてKotlinで作成した場合、エラーが発生しビルドできない。

これは一度プロジェクトをクリーンしてコンパイルし直すと必ず再現する。（コンパイルするタイミングによってエラーメッセージが変わったりコンパイルできたりするが、クリーンした後コンパイルすると必ず発生する）

```
error: cannot access NonExistentClass
  class file for error.NonExistentClass not found
  Consult the following stack trace for details.
  com.sun.tools.javac.code.Symbol$CompletionFailure: class file for error.NonExistentClass not found
1 error

:app:compileDebugJavaWithJavac FAILED

FAILURE: Build failed with an exception.
```

スタックトレースは[stacktrace](stacktrace)を参照のこと。

## 環境

+ Android Studio 2.0 Beta 7
+ jdk 1.8.0_73
+ Kotlin 1.0.1

## 確認したこと

+ フルKotlin ＋ Dagger2で依存性の注入はできる（dagger_kotlin_exclude_ormaブランチ）
+ 全てJavaの場合動作する(dagger_javaブランチ)
+ Annotation Processingによってコード生成されたクラスをDagger2で扱うとコンパイルできない（DataBindingとOrmaで確認）
+ それは@Providesもしくは@Injectのどちらかにでも指定されていれば生じる
+ 既にOrmaやDataBindingのコードが生成済みであればDagger2で扱ってもコンパイルできる

## 考えられる原因

~~`provideOrmaDatabase()`や`@Inject lateinit var orma:OrmaDatabase`をコメントアウトすればコンパイルできることから、Dagger2がkapt上ではAnnotation Processingによって生成されたコードをうまく参照できていないと思われる。

[kaptのIssue KT-10352](https://youtrack.jetbrains.com/issue/KT-10352)の現象に近い気がする。

この現象は、Dagger2でAnnotation Processingによって生成されるクラスを参照するようになると生じる。

Javaオンリーの環境では再現しないことから、kaptではコード生成による依存関係をうまく裁くことができていないものと思われる。
このサンプルの状態で言えば、Dagger2のコード生成をするのにOrmaのコード生成が必要な状態になってしまっているせいで起こる。
先にOrmaのコード生成をすべて処理した後にDagger2のコード生成を行ってくれれば問題がないのだが、その順番をうまく解決できないのだと思う。
kaptによるコード生成のプロセス中では、生成するコード同士がお互いを参照できないのか、もしくは生成する順番を制御できないのかもしれない。~~

kaptの仕組み上どうしようもないらしい。
ただ、Dagger2で直接Annotation Processingで生成するコードをprovideしないようにしなければ、この問題は回避できる。
このリポジトリでは、OrmaProviderというクラスでOrmaDatabaseをラップすることで回避している。

> You have types generated by Annotation Processing in your declaration signatures, like fun provideOrmaDatabase(context: Context) or lateinit var orma: OrmaDatabase. Because Kotlin makes its stubs before Java Annotation Processing runs, Kotlin knows just nothing about OrmaDatabase, and the name of the declaration in stubs will be error.NonExistentClass. This breaks the Annotation Processing tool.
 It's a kind of kapt limitation, and we currently doesn't know a way to fix it without reimplementing Annotation Processing in Kotlin.
 But as a workaround, you can change the return type to DatabaseHandle, and make an explicit cast inside your function, this fixes the build.
 

以下を参照のこと。

- [https://kotlinlang-jp.slack.com/archives/android/p1464803567000032](https://kotlinlang-jp.slack.com/archives/android/p1464803567000032)
- [http://qiita.com/chibatching/items/e5a0f5016093abec884b](http://qiita.com/chibatching/items/e5a0f5016093abec884b)
